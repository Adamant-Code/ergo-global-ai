# Use Node.js 20 LTS for Express API
FROM node:22.11.0-alpine

# Install Python and build dependencies for native modules
RUN apk add --no-cache python3 make g++

# Set working directory
WORKDIR /app

# Copy monorepo root files for workspace resolution
COPY package.json turbo.json package-lock.json ./

# Copy the shared package first
COPY packages/requestResponse ./packages/requestResponse

# Build the shared package
RUN npm ci -w @request-response/types && npm run build -w @request-response/types

# Copy server files, including .env
COPY apps/server ./apps/server

# Install server dependencies
WORKDIR /app/apps/server
RUN npm ci && npm run build

# Clean up build dependencies to reduce image size
RUN apk del python3 make g++

# Make the entrypoint script executable
RUN chmod +x ./docker-entrypoint.sh
ENV NODE_ENV=development

# Set the custom entrypoint
ENTRYPOINT ["/app/apps/server/docker-entrypoint.sh"]

# Expose API port
EXPOSE 4000

# The CMD will be passed as arguments to the ENTRYPOINT script
CMD ["npm", "run", "dev"]